<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name='viewport' content='width=640,user-scalable=no'/>
	<title>我真的是陈坤</title>
	<link rel="stylesheet" href="css/index.css">
</head>
<body>
	<div id="container">
		<audio id="k_ring" preload="load" loop="loop" autoplay="autoplay">
			<source type="audio/mpeg" src="media/ring.mp3" />
		</audio>
		<audio id="k_audio" preload="load">
			<source type="audio/mpeg" src="media/k_audio.mp3" />
		</audio>
		<audio id="k_msg" preload="load">
			<source type="audio/mpeg" src="media/msg.mp3" />
		</audio>
		<audio id="k_msg2" preload="load">
			<source type="audio/mpeg" src="media/msg.mp3" />
		</audio>
		<div class="top">
			<img class="tonghua" src="img/tonghua.png" />
			<div class="touxiang_circle">
			</div>
			<div class="tonghua_dumiao">
				<div class="second">00:00</div>
				<canvas class="canvas" id="canvas_1" width="260" height="260" style="opacity:.4;"></canvas>
				<canvas class="canvas" id="canvas_2" width="260" height="260"></canvas>
			</div>
			<img class="touxiang" src="img/k_touxiang.png" />
			<img class="address" src="img/k_mingzi.png" />
		</div>

		<div class="jieting">
			<div class="jieting_btn">
				<div class="btn_inner"></div>
			</div>
		</div>

		<div class="keybord">
			<div class="hungUp_btn"></div>
		</div>

		<div class="message">
			<img class="msg_01" src="img/k_msg01.png"/>
			<img class="msg_02" src="img/k_msg02.png"/>
		</div>
	</div>
	

	<script src="js/jquery-2.1.3.js"></script>
	<script type="text/javascript">
	$(function(){

		// 根据手机屏幕，缩放container
		var $win = $(window),
			$container = $("#container");
			
		function scaleContainer(){
		    var nWinW = $win.width(),
		        nWinH = $win.height(),
		        nScaleW,
		        nScaleH;

		    if(nWinH <= 480){
		    	if(nWinW > 640){
		    	    nWinW = 640;
		    	}
		    	if(nWinH > 1136){
		    	    nWinH = 1056;
		    	}

		    	nScaleW = nWinW/640;
		    	nScaleH = nWinH/1056;

		    	$container.css({
		    	    '-webkit-transform':'scale(' + nScaleW+',' + nScaleH+')',
		    	    'transform':'scale(' + nScaleW+',' + nScaleH+')'
		    	});
		    }
		    
		}

		scaleContainer();

		$win.resize(scaleContainer);

		var k_audio = document.getElementById("k_audio"),
			k_ring = document.getElementById("k_ring"),
			k_msg = document.getElementById("k_msg"),
			k_msg2 = document.getElementById("k_msg2");

		k_ring.play();


		// 挂断之后直接跳转到宣传页面
		$(document).on("touchstart",".hungUp_btn",function(){
			k_audio.pause();
			window.location.href="answer.html";
		});

		$(document).on("touchstart",function(e){
			e.preventDefault();
		});

		var $jieting = $(".jieting"),
			$jietingBtn = $(".jieting_btn"),
			$tonghua = $(".tonghua"),
			oLeft = $jietingBtn.position().left,  // 初始值
			nLeft,  
			nFix;   // 修正值

		$jietingBtn.on("touchstart",function(e){
			e.preventDefault();

			if(e.originalEvent){
				e = e.originalEvent;
			}
			var $this = $(this),
				touch = e.touches[0],
				nStartLeft = touch.pageX;

			nLeft = $this.position().left;
			nFix = nStartLeft - nLeft;

			$this.addClass("jieting_down");

			$(document).on("touchmove",function(e){

				if(e.originalEvent){
					e = e.originalEvent;
				}

				var touch = e.touches[0];

				nLeft = touch.pageX - nFix;

				if(nLeft <= -40){
					nLeft = -40;
				}
				if(nLeft >= 400){
					nLeft = 400;
				}

				$jietingBtn.css({'left':nLeft});

			}).on("touchend",function(e){

				$jietingBtn.removeClass("jieting_down");

				if(nLeft <= -15 || nLeft >= 380) {
					if(nLeft <= 15) {    // 挂断电话，跳转到信息页面
						$(".top").hide();
						$(".jieting").hide();
						$(".message").addClass("message_on");
						
						setTimeout(function(){
							k_msg.play();
							$(".msg_01").fadeIn(200);
						},600);
						setTimeout(function(){
							k_msg2.play();
							$(".msg_02").fadeIn(200);
						},2000);
						setTimeout(function(){
							window.location.href="answer.html";
						},4200);
					}
					if(nLeft >= 380){    // 接听电话，播放录音

						setTimeout(function(){
							k_audio.play();
						},800);
						

						$(".tonghua_dumiao").show();
						$(".touxiang_circle").hide();

						// 通话读秒圆弧背景
						var canvas_1 = document.getElementById("canvas_1"),
							ctx_1 = canvas_1.getContext('2d');

						ctx_1.strokeStyle = "#aaa";
						ctx_1.lineWidth = 3;
						ctx_1.beginPath();
						ctx_1.arc(130,130,124,-0.4*Math.PI,Math.PI*1.4);
						ctx_1.stroke();
						ctx_1.closePath();

						// 实时更新的圆弧
						var canvas_2 = document.getElementById("canvas_1"),
							ctx_2 = canvas_2.getContext('2d');

						ctx_2.strokeStyle = "#fff2b7";
						ctx_2.lineWidth = 3;

						var arc = -0.4,
							n = 1.8 / 600;
						
						var arcTimer = setInterval(function(){
							if(arc < 1.4){
								arc += n;
								ctx_2.beginPath();
								ctx_2.arc(130,130,124,-0.4*Math.PI,Math.PI*arc);
								ctx_2.stroke();
								ctx_2.closePath();
							}else{
								clearInterval(arcTimer);
							}
						},50);

						// 通话读秒
						var $second = $(".second"),
							secNum = 0;
						var secTimer = setInterval(function(){
							if(secNum < 30){
								secNum ++;
								var text = secNum < 10 ? "0" + secNum : secNum;
								$second.text("00:" + text);
							}else{

								clearInterval(secTimer);

								// 读秒（30）之后直接跳转到宣传页面
								window.location.href="answer.html";
							}
						},1000);
						
						setTimeout(function(){    // 延迟出现键盘
							$(".keybord").addClass("keybordUp");
							$tonghua.addClass("tonghua_show");
						},200);
					}

					$jieting.fadeOut(200);
					k_ring.pause();

				}else{
					$this.css({"left": oLeft});
				}

				// 取消document上的touchmove事件
				$(document).off("touchmove").off("touchend");
			});

		});

	});
	
	</script>
</body>
</html>